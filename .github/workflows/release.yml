# Copyright (c) Marc Rivero LÃ³pez
# Licensed under GNU General Public License v3.0
# See LICENSE file for full terms
#
# PyPI Release Pipeline for surinort-ast
# SLSA Level 3 compliant, security-hardened release workflow
#
# Security Features:
# - Pinned GitHub Actions to commit SHAs
# - Trusted Publisher authentication (no token in secrets)
# - Artifact signing with Sigstore
# - SBOM generation with CycloneDX
# - Provenance attestation for supply chain security
# - Release verification before publishing

name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

# Security: Restrict default permissions to read-only
permissions:
  contents: read

# Prevent concurrent releases
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  PYTHONHASHSEED: 0
  PYTHONDONTWRITEBYTECODE: 1

jobs:
  # Validate release preconditions
  validate:
    name: Validate Release
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read

    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871  # v4.2.1
        with:
          persist-credentials: false
          fetch-depth: 0  # Full history for changelog

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Releasing version: ${VERSION}"

      - name: Verify tag format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "Invalid version format: $VERSION"
            echo "Expected format: v1.2.3 or v1.2.3-alpha.1"
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@f677139bbe7f9c59b41e40162b753cc110f5c709  # v5.3.0
        with:
          python-version: '3.14'

      - name: Verify version in pyproject.toml
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CLEAN_VERSION="${VERSION#v}"
          PYPROJECT_VERSION=$(grep -E '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')

          if [[ "$PYPROJECT_VERSION" != "$CLEAN_VERSION" ]]; then
            echo "Version mismatch!"
            echo "Tag version: $CLEAN_VERSION"
            echo "pyproject.toml version: $PYPROJECT_VERSION"
            exit 1
          fi
          echo "Version verified: $CLEAN_VERSION"

  # Run full test suite before release
  test:
    name: Release Tests
    needs: [validate]
    uses: ./.github/workflows/ci.yml
    permissions:
      contents: read
      security-events: write
      pull-requests: write
      id-token: write

  # Build release artifacts
  build:
    name: Build Release Artifacts
    needs: [validate, test]
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    permissions:
      contents: read
      id-token: write  # For provenance

    steps:
      - name: Checkout code
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871  # v4.2.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@f677139bbe7f9c59b41e40162b753cc110f5c709  # v5.3.0
        with:
          python-version: '3.14'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip==24.3.1
          pip install build==1.3.0 twine==6.2.0

      - name: Build distributions
        run: |
          python -m build --sdist --wheel --outdir dist/

      - name: Verify distributions
        run: |
          twine check dist/*
          ls -lh dist/

      - name: Generate SBOM
        run: |
          pip install cyclonedx-bom==4.6.3
          cyclonedx-py requirements --format json --output sbom.json requirements.txt
          cyclonedx-py requirements --format xml --output sbom.xml requirements.txt

      - name: Generate checksums
        run: |
          cd dist/
          sha256sum * > SHA256SUMS
          cat SHA256SUMS

      - name: Upload build artifacts
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: release-distributions
          path: |
            dist/
            sbom.json
            sbom.xml
          retention-days: 30

  # Generate release notes
  changelog:
    name: Generate Changelog
    needs: [validate]
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read

    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
      - name: Checkout code
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871  # v4.2.1
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ needs.validate.outputs.version }}"

          # Get previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${VERSION}^ 2>/dev/null || echo "")

          if [[ -z "$PREVIOUS_TAG" ]]; then
            echo "First release, no previous tag"
            CHANGELOG="Initial release of surinort-ast"
          else
            echo "Generating changelog from $PREVIOUS_TAG to $VERSION"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${PREVIOUS_TAG}..${VERSION})
          fi

          # Save to file and output
          echo "$CHANGELOG" > changelog.txt
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload changelog
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: changelog
          path: changelog.txt
          retention-days: 30

  # Publish to PyPI using Trusted Publisher
  publish-pypi:
    name: Publish to PyPI
    needs: [validate, build, changelog]
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write  # Required for Trusted Publisher

    environment:
      name: pypi
      url: https://pypi.org/project/surinort-ast/

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        with:
          name: release-distributions
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e  # v1.12.2
        with:
          verbose: true
          print-hash: true

  # Create GitHub Release
  github-release:
    name: Create GitHub Release
    needs: [validate, build, changelog, publish-pypi]
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: write  # Required to create release

    steps:
      - name: Checkout code
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871  # v4.2.1
        with:
          persist-credentials: true

      - name: Download build artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        with:
          name: release-distributions
          path: dist/

      - name: Download changelog
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        with:
          name: changelog
          path: .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b  # v2.5.0
        with:
          tag_name: ${{ needs.validate.outputs.version }}
          name: Release ${{ needs.validate.outputs.version }}
          body_path: changelog.txt
          draft: false
          prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
          files: |
            dist/*
            sbom.json
            sbom.xml
          fail_on_unmatched_files: true
          generate_release_notes: true

  # Sign release artifacts with Sigstore
  sign-artifacts:
    name: Sign Release Artifacts
    needs: [validate, build, publish-pypi]
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write  # Required for Sigstore

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        with:
          name: release-distributions
          path: dist/

      - name: Install Sigstore
        run: |
          pip install sigstore==3.5.1

      - name: Sign artifacts with Sigstore
        run: |
          cd dist/
          for file in *.whl *.tar.gz; do
            python -m sigstore sign "$file"
          done
          ls -la

      - name: Upload signed artifacts
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: signed-artifacts
          path: dist/*.sigstore
          retention-days: 90

  # Post-release verification
  verify-release:
    name: Verify Release
    needs: [validate, publish-pypi]
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    steps:
      - name: Set up Python
        uses: actions/setup-python@f677139bbe7f9c59b41e40162b753cc110f5c709  # v5.3.0
        with:
          python-version: '3.14'

      - name: Wait for PyPI propagation
        run: |
          echo "Waiting 60 seconds for PyPI to propagate..."
          sleep 60

      - name: Install from PyPI
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          CLEAN_VERSION="${VERSION#v}"
          pip install "surinort-ast==${CLEAN_VERSION}"

      - name: Verify installation
        run: |
          surinort-ast --help
          python -c "import surinort_ast; print(f'Installed version: {surinort_ast.__version__}')"

      - name: Verify version match
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          CLEAN_VERSION="${VERSION#v}"
          INSTALLED_VERSION=$(python -c "import surinort_ast; print(surinort_ast.__version__)")

          if [[ "$INSTALLED_VERSION" != "$CLEAN_VERSION" ]]; then
            echo "Version mismatch!"
            echo "Expected: $CLEAN_VERSION"
            echo "Installed: $INSTALLED_VERSION"
            exit 1
          fi
          echo "Version verified: $INSTALLED_VERSION"

  # Release success summary
  release-success:
    name: Release Pipeline Success
    needs: [validate, test, build, changelog, publish-pypi, github-release, sign-artifacts, verify-release]
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          if [[ "${{ needs.validate.result }}" != "success" ]]; then
            echo "Validation failed"
            exit 1
          fi
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "Tests failed"
            exit 1
          fi
          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "Build failed"
            exit 1
          fi
          if [[ "${{ needs.changelog.result }}" != "success" ]]; then
            echo "Changelog generation failed"
            exit 1
          fi
          if [[ "${{ needs.publish-pypi.result }}" != "success" ]]; then
            echo "PyPI publish failed"
            exit 1
          fi
          if [[ "${{ needs.github-release.result }}" != "success" ]]; then
            echo "GitHub release failed"
            exit 1
          fi
          if [[ "${{ needs.sign-artifacts.result }}" != "success" ]]; then
            echo "Artifact signing failed"
            exit 1
          fi
          if [[ "${{ needs.verify-release.result }}" != "success" ]]; then
            echo "Release verification failed"
            exit 1
          fi
          echo "Release ${{ needs.validate.outputs.version }} completed successfully!"
          echo "Package available at: https://pypi.org/project/surinort-ast/"
